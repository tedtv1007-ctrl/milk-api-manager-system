@page "/sync-status"
@using MilkAdminBlazor.Data
@inject ApisixService ApisixService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" GutterBottom="true">ğŸ”„ ç¾¤çµ„åŒæ­¥ç‹€æ…‹ (Group Sync Status)</MudText>
<MudText Typo="Typo.body1" Class="mb-4">æŸ¥çœ‹èˆ‡ Active Directory (AD) çš„ç¾¤çµ„åŒæ­¥é€²åº¦èˆ‡çµæœã€‚</MudText>

<MudPaper Class="pa-4">
    <MudGrid>
        <MudItem xs="12" sm="6">
            <MudText Typo="Typo.h6">ç•¶å‰ç‹€æ…‹</MudText>
            <MudChip Color="@GetStatusColor(_status)" Variant="Variant.Filled" Size="Size.Large">@_status</MudChip>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudText Typo="Typo.h6">æœ€å¾ŒåŒæ­¥æ™‚é–“</MudText>
            <MudText Typo="Typo.body1">@(_lastSyncTime?.ToString("yyyy-MM-dd HH:mm:ss") ?? "å¾æœªåŒæ­¥")</MudText>
        </MudItem>
    </MudGrid>
    
    <MudDivider Class="my-4" />
    
    <MudText Typo="Typo.subtitle1" Class="mb-2">åŒæ­¥èªªæ˜</MudText>
    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
        æ­¤æœå‹™æœƒè‡ªå‹•å°‡ AD ä¸­çš„ä½¿ç”¨è€…ç¾¤çµ„åŒæ­¥è‡³ APISIX çš„ Consumer Groupsã€‚
        åŒæ­¥é »ç‡ï¼šæ¯ 30 åˆ†é˜ä¸€æ¬¡ã€‚
    </MudAlert>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RefreshStatus" StartIcon="@Icons.Material.Filled.Refresh" Class="mt-4">
        é‡æ–°æ•´ç†ç‹€æ…‹
    </MudButton>
</MudPaper>

@code {
    private string _status = "Loading...";
    private DateTime? _lastSyncTime;

    protected override async Task OnInitializedAsync()
    {
        await RefreshStatus();
    }

    private async Task RefreshStatus()
    {
        var result = await ApisixService.GetSyncStatusAsync();
        if (result != null)
        {
            _status = result.Status;
            _lastSyncTime = result.LastSyncTime;
        }
        else
        {
            _status = "Unknown";
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Syncing" => Color.Info,
        "Success" => Color.Success,
        "Failed" => Color.Error,
        "Idle" => Color.Default,
        _ => Color.Warning
    };
}
