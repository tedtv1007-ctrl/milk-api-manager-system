@page "/apis"
@using MilkAdminBlazor.Data
@inject ApisixService ApisixService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex align-center mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Api" Size="Size.Large" Class="mr-3" Color="Color.Primary" />
        <MudText Typo="Typo.h4">API Governance & Inventory</MudText>
    </div>
    
    <MudTable Items="@apis" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info" Elevation="3">
        <HeaderContent>
            <MudTh>Service Name</MudTh>
            <MudTh>Upstream Path</MudTh>
            <MudTh>Risk Level</MudTh>
            <MudTh>Owner</MudTh>
            <MudTh Style="text-align:right">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">
                <MudText Typo="Typo.body1" Style="font-weight: 500">@context.Name</MudText>
            </MudTd>
            <MudTd DataLabel="Path">
                <code>@context.Uri</code>
            </MudTd>
            <MudTd DataLabel="Risk">
                <MudChip T="string" Color="@GetRiskColor(context.RiskLevel)" Size="Size.Small" Variant="Variant.Filled">@context.RiskLevel</MudChip>
            </MudTd>
            <MudTd DataLabel="Owner">@context.Owner</MudTd>
            <MudTd DataLabel="Whitelist">
                @if (context.WhitelistIps.Any())
                {
                    <MudText Typo="Typo.caption">@string.Join(", ", context.WhitelistIps)</MudText>
                }
                else
                {
                    <MudText Typo="Typo.caption" Color="Color.Default">None</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Actions" Style="text-align:right">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => OpenEditDialog(context))" />
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">Details</MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudDialog @bind-IsVisible="isDialogOpen" Options="dialogOptions">
        <TitleContent>
            <MudText Typo="Typo.h6">Edit Route: @editingApi?.Name</MudText>
        </TitleContent>
        <DialogContent>
            <RouteWhitelistManager RouteId="@editingApi?.Id" />
        </DialogContent>
        <DialogActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveRoute">Save</MudButton>
            <MudButton OnClick="@(() => isDialogOpen = false)">Cancel</MudButton>
        </DialogActions>
    </MudDialog>
</MudContainer>

@code {
    private bool loading = true;
    private List<ApiRoute> apis = new();
    private bool isDialogOpen;
    private ApiRoute? editingApi;
    private string whitelistInput = "";
    private DialogOptions dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        // 模擬從 APISIX Admin API 讀取資料
        apis = await ApisixService.GetRoutesAsync();
        loading = false;
    }

    private void OpenEditDialog(ApiRoute api)
    {
        editingApi = api;
        whitelistInput = string.Join(", ", api.WhitelistIps);
        isDialogOpen = true;
    }

    private async Task SaveRoute()
    {
        if (editingApi != null)
        {
            // Fetch the current whitelist from APISIX and update the local model
            var ips = await ApisixService.GetRouteWhitelistAsync(editingApi.Id);
            if (ips != null)
            {
                // Convert DTO list to list of IP strings
                editingApi.WhitelistIps = ips.Select(e => e.Ip).ToList();
            }

            // Persist the updated route back to backend/APISIX
            await ApisixService.UpdateRouteAsync(editingApi);
        }
        isDialogOpen = false;
    }

    private Color GetRiskColor(string level) => level switch
    {
        "L3" => Color.Error,    // High Risk
        "L2" => Color.Warning,  // Medium Risk
        _ => Color.Success      // Low Risk
    };
}
