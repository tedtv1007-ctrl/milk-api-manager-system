@page "/consumers"
@using MilkAdminBlazor.Data
@inject ApisixService ApisixService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" GutterBottom="true">ğŸ‘¥ API æ¶ˆè²»è€…æ¬Šé™ç®¡ç† (Consumers)</MudText>
<MudText Typo="Typo.body1" Class="mb-4">åœ¨æ­¤ç®¡ç† API ä½¿ç”¨è€…åŠå…¶è§’è‰² (Roles) èˆ‡æ¬Šé™ç¯„åœ (Scopes)ã€‚</MudText>

<MudTable Items="@_consumers" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>ä½¿ç”¨è€…åç¨±</MudTh>
        <MudTh>æè¿°</MudTh>
        <MudTh>è§’è‰²èˆ‡æ¬Šé™ (Labels)</MudTh>
        <MudTh>æ“ä½œ</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Username">@context.Username</MudTd>
        <MudTd DataLabel="Desc">@context.Desc</MudTd>
        <MudTd DataLabel="Labels">
            @foreach (var label in context.Labels)
            {
                <MudChip Color="@(label.StartsWith("role:") ? Color.Primary : Color.Secondary)" Size="Size.Small">@label</MudChip>
            }
        </MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" OnClick="@(() => EditConsumer(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteConsumer(context.Username))" />
        </MudTd>
    </RowTemplate>
</MudTable>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddConsumer" Class="mt-4">æ–°å¢æ¶ˆè²»è€…</MudButton>

<MudDialog @bind-IsVisible="_editDialogOpen" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(_isEditing ? "ç·¨è¼¯æ¶ˆè²»è€…" : "æ–°å¢æ¶ˆè²»è€…")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_currentConsumer.Username" Label="ä½¿ç”¨è€…åç¨±" Variant="Variant.Outlined" ReadOnly="@_isEditing" />
        <MudTextField @bind-Value="_currentConsumer.Desc" Label="æè¿°" Variant="Variant.Outlined" Class="mt-4" />
        
        <MudText Typo="Typo.subtitle2" Class="mt-4">è§’è‰²èˆ‡æ¬Šé™åˆ†é…</MudText>
        <div class="d-flex flex-wrap gap-2 mt-2">
            @foreach (var role in _availableRoles)
            {
                <MudChip Color="Color.Primary" Variant="@(_selectedRoles.Contains(role) ? Variant.Filled : Variant.Outlined)" OnClick="@(() => ToggleRole(role))">@role</MudChip>
            }
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2">
            @foreach (var scope in _availableScopes)
            {
                <MudChip Color="Color.Secondary" Variant="@(_selectedScopes.Contains(scope) ? Variant.Filled : Variant.Outlined)" OnClick="@(() => ToggleScope(scope))">@scope</MudChip>
            }
        </div>
        
        <MudTextField @bind-Value="_labelsText" Label="è‡ªå®šç¾© Labels (ä»¥é€—è™Ÿåˆ†éš”)" Variant="Variant.Outlined" Class="mt-4" />
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="CloseDialog">å–æ¶ˆ</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveConsumer">å„²å­˜</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ApiConsumer> _consumers = new();
    private bool _loading = true;
    private bool _editDialogOpen;
    private bool _isEditing;
    private ApiConsumer _currentConsumer = new();
    private string _labelsText = "";
    private DialogOptions _dialogOptions = new() { FullWidth = true };

    private readonly string[] _availableRoles = { "admin", "developer", "auditor", "operator" };
    private readonly string[] _availableScopes = { "read:all", "write:all", "user:info", "payment:process", "report:view" };
    private HashSet<string> _selectedRoles = new();
    private HashSet<string> _selectedScopes = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadConsumers();
    }

    private async Task LoadConsumers()
    {
        _loading = true;
        _consumers = await ApisixService.GetConsumersAsync();
        _loading = false;
    }

    private void AddConsumer()
    {
        _isEditing = false;
        _currentConsumer = new ApiConsumer();
        _labelsText = "";
        _selectedRoles.Clear();
        _selectedScopes.Clear();
        _editDialogOpen = true;
    }

    private void EditConsumer(ApiConsumer consumer)
    {
        _isEditing = true;
        _currentConsumer = new ApiConsumer
        {
            Username = consumer.Username,
            Desc = consumer.Desc,
            Labels = new List<string>(consumer.Labels)
        };
        
        _selectedRoles = _currentConsumer.Labels.Where(l => l.StartsWith("role:")).Select(l => l.Replace("role:", "")).ToHashSet();
        _selectedScopes = _currentConsumer.Labels.Where(l => l.StartsWith("scope:")).Select(l => l.Replace("scope:", "")).ToHashSet();
        _labelsText = string.Join(", ", _currentConsumer.Labels.Where(l => !l.StartsWith("role:") && !l.StartsWith("scope:")));
        
        _editDialogOpen = true;
    }

    private void ToggleRole(string role)
    {
        if (_selectedRoles.Contains(role)) _selectedRoles.Remove(role);
        else _selectedRoles.Add(role);
    }

    private void ToggleScope(string scope)
    {
        if (_selectedScopes.Contains(scope)) _selectedScopes.Remove(scope);
        else _selectedScopes.Add(scope);
    }

    private async Task SaveConsumer()
    {
        if (string.IsNullOrWhiteSpace(_currentConsumer.Username))
        {
            Snackbar.Add("ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º", Severity.Error);
            return;
        }

        var labels = _labelsText.Split(',')
            .Select(s => s.Trim())
            .Where(s => !string.IsNullOrEmpty(s))
            .ToList();

        labels.AddRange(_selectedRoles.Select(r => $"role:{r}"));
        labels.AddRange(_selectedScopes.Select(s => $"scope:{s}"));

        _currentConsumer.Labels = labels;

        await ApisixService.UpdateConsumerAsync(_currentConsumer);
        _editDialogOpen = false;
        await LoadConsumers();
        Snackbar.Add("å„²å­˜æˆåŠŸ", Severity.Success);
    }

    private async Task DeleteConsumer(string username)
    {
        await ApisixService.DeleteConsumerAsync(username);
        await LoadConsumers();
        Snackbar.Add("åˆªé™¤æˆåŠŸ", Severity.Success);
    }

    private void CloseDialog()
    {
        _editDialogOpen = false;
    }
}
