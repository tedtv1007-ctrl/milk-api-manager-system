@page "/audit-logs"
@using MilkApiManager.Models
@using MilkApiManager.Services
@inject AuditLogService AuditLogService

<MudTable Items="@_logs" Hover="true" Filter="new Func<AuditLogEntry,bool>(FilterFunc)">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Audit Logs</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Timestamp</MudTh>
        <MudTh>User</MudTh>
        <MudTh>Action</MudTh>
        <MudTh>Resource</MudTh>
        <MudTh>Details</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Timestamp">@context.Timestamp</MudTd>
        <MudTd DataLabel="User">@context.User</MudTd>
        <MudTd DataLabel="Action"><MudChip T="string" Color="Color.Info" Size="Size.Small">@context.Action</MudChip></MudTd>
        <MudTd DataLabel="Resource">@context.Resource</MudTd>
        <MudTd DataLabel="Details">
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap; word-break: break-all;">
                @(context.DetailsJson?.Length > 50 ? context.DetailsJson.Substring(0, 50) + "..." : context.DetailsJson)
            </MudText>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private string _searchString = "";
    private List<AuditLogEntry> _logs = new();

    protected override async Task OnInitializedAsync()
    {
        _logs = await AuditLogService.GetLogsAsync(500);
    }

    private bool FilterFunc(AuditLogEntry element) => FilterFunc1(element, _searchString);

    private bool FilterFunc1(AuditLogEntry element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.User.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.Action.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.Resource.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }
}
